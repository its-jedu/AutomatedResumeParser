<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AutomatedResumeParser • Playground</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    h2 { margin-top: 28px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input[type=text], textarea { width: 100%; padding: 8px; }
    textarea { height: 130px; }
    button { padding: 8px 14px; cursor: pointer; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; }
    .ok { color: #0a7; } .err { color: #c00; } .mono { font-family: ui-monospace, Consolas, monospace; }
    ul { margin: 8px 0 0 16px; }
  </style>
</head>
<body>
  <h1>AutomatedResumeParser — Test Console</h1>
  <p>Flow: <b>Login → Create Job → Upload Resume → Match → Export</b></p>

  <div class="card">
    <h2>1) Login (JWT)</h2>
    <div class="row">
      <input id="u" type="text" placeholder="username">
      <input id="p" type="password" placeholder="password">
      <button onclick="login()">Get Token</button>
      <span id="tokStatus"></span>
    </div>
    <div class="mono" id="tok"></div>
  </div>

  <div class="card">
    <h2>2) Create Job</h2>
    <input id="jobTitle" type="text" placeholder="Job title e.g. Backend Engineer (Django + Selenium)">
    <p>Description</p>
    <textarea id="jobDesc" placeholder="Paste the full job description here..."></textarea>
    <div class="row">
      <button onclick="extractKeywords()">Auto-extract keywords</button>
      <input id="jobKeywords" type="text" placeholder="Keywords csv e.g. django,rest,selenium,postgresql" style="flex:1">
      <button onclick="createJob()">Create Job</button>
      <span id="jobStatus"></span>
    </div>
    <div class="mono" id="jobsList"></div>
  </div>

  <div class="card">
    <h2>3) Upload Resume</h2>
    <div class="row">
      <input id="resumeFile" type="file" accept=".pdf,.docx,.txt">
      <button onclick="uploadResume()">Upload</button>
      <span id="resumeStatus"></span>
    </div>
    <div id="resumesList" class="mono"></div>
  </div>

  <div class="card">
    <h2>4) Match</h2>
    <div class="row">
      <input id="matchResumeId" type="text" placeholder="resume_id">
      <input id="matchJobId" type="text" placeholder="job_id">
      <button onclick="match()">Compute Match</button>
      <span id="matchStatus"></span>
    </div>
    <div id="matchResult" class="mono"></div>
  </div>

<script>
  let token = null;

  function show(el, msg, cls="") { const e = document.getElementById(el); e.textContent = msg; e.className = cls; }
  function authHeader() { return token ? { "Authorization": "Bearer " + token } : {}; }

  async function login() {
    const body = { username: document.getElementById('u').value.trim(),
                   password: document.getElementById('p').value };
    const r = await fetch('/api/auth/token/', {
      method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body)
    });
    const j = await r.json();
    if (r.ok) {
      token = j.access;
      show('tokStatus', 'OK', 'ok'); show('tok', token);
      await listJobs(); await listResumes();
    } else { show('tokStatus', j.detail || 'Login failed', 'err'); }
  }

  async function extractKeywords() {
    const desc = document.getElementById('jobDesc').value;
    const r = await fetch('/api/jobs/keywords/', {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ description: desc })
    });
    const j = await r.json();
    if (r.ok) {
      document.getElementById('jobKeywords').value = j.keywords.join(',');
    } else { alert('Keyword extract failed: ' + (j.detail || r.status)); }
  }

  async function createJob() {
    const title = document.getElementById('jobTitle').value.trim();
    const description = document.getElementById('jobDesc').value;
    const keywords = document.getElementById('jobKeywords').value.split(',').map(s => s.trim()).filter(Boolean);
    const r = await fetch('/api/jobs/', {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ title, description, keywords })
    });
    const j = await r.json();
    if (r.ok) { show('jobStatus', `Created job id=${j.id}`, 'ok'); listJobs(); }
    else { show('jobStatus', j.detail || 'Failed', 'err'); }
  }

  async function listJobs() {
    const r = await fetch('/api/jobs/', { headers: { ...authHeader() }});
    const j = await r.json();
    if (r.ok) {
      const lines = (Array.isArray(j) ? j : j.results || []).map(x => `id=${x.id} • ${x.title}`).join('\n');
      document.getElementById('jobsList').textContent = lines || '(no jobs yet)';
    }
  }

  async function uploadResume() {
    const f = document.getElementById('resumeFile').files[0];
    if (!f) return alert('Choose a file');
    const fd = new FormData(); fd.append('file', f);
    const r = await fetch('/api/resumes/', { method:'POST', headers: { ...authHeader() }, body: fd });
    const j = await r.json();
    if (r.ok) { show('resumeStatus', `Uploaded resume id=${j.id}`, 'ok'); listResumes(); }
    else { show('resumeStatus', j.detail || 'Upload failed', 'err'); }
  }

  async function listResumes() {
    const r = await fetch('/api/resumes/', { headers: { ...authHeader() }});
    const j = await r.json();
    if (r.ok) {
      const arr = Array.isArray(j) ? j : j.results || [];
      document.getElementById('resumesList').textContent =
        arr.map(x => `id=${x.id} • email=${x.email || '-'} • skills=[${(x.skills||[]).join(', ')}]`).join('\n') || '(no resumes yet)';
      if (arr[0]) document.getElementById('matchResumeId').value = arr[0].id;
    }
  }

  async function match() {
    const resume_id = parseInt(document.getElementById('matchResumeId').value);
    const job_id = parseInt(document.getElementById('matchJobId').value);
    const r = await fetch('/api/match/', {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ resume_id, job_id })
    });
    const j = await r.json();
    if (r.ok) {
      show('matchStatus', `Score ${j.score}%`, 'ok');
      document.getElementById('matchResult').textContent = JSON.stringify(j, null, 2);
      if (j.id) {
        const br = document.createElement('br');
        const b1 = document.createElement('button'); b1.textContent = 'Download PDF';
        b1.onclick = () => downloadFile(`/api/match/${j.id}/export/pdf/`, `match_${j.id}.pdf`);
        const b2 = document.createElement('button'); b2.textContent = 'Download CSV'; b2.style.marginLeft='8px';
        b2.onclick = () => downloadFile(`/api/match/${j.id}/export/csv/`, `match_${j.id}.csv`);
        const box = document.getElementById('matchResult');
        box.appendChild(br); box.appendChild(b1); box.appendChild(b2);
      }
    } else { show('matchStatus', j.detail || 'Match failed', 'err'); }
  }

  async function downloadFile(url, filename) {
    const r = await fetch(url, { headers: { ...authHeader() } });
    if (!r.ok) { alert('Download failed: ' + r.status); return; }
    const blob = await r.blob();
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link); link.click();
    link.remove(); URL.revokeObjectURL(link.href);
  }
</script>
</body>
</html>
